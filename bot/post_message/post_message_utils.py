from aiogram.types import CallbackQuery, Message

from bot.keyboards.main_menu_keyboards import ReplyBotMenuKeyboard
from database.config import post_message_db, contest_db
from database.models.post_message_model import PostMessageSchema, PostMessageNotFoundError, PostMessageType, \
    UnknownPostMessageTypeError
from database.models.post_message_media_files import PostMessageMediaFileSchema

from logs.config import extra_params, logger


async def is_post_message_valid(
        query: CallbackQuery,
        post_message: PostMessageSchema,
        post_message_type: PostMessageType,
        media_files: list[PostMessageMediaFileSchema]
) -> bool:
    """
    Check if Post Message is valid for telegram and specific post_message_type

    :raises UnknownPostMessageTypeError:
    """
    match post_message_type:
        case PostMessageType.MAILING:
            pass
        case PostMessageType.CHANNEL_POST:
            pass
        case PostMessageType.CONTEST:
            contest = await contest_db.get_contest_by_post_message_id(post_message.post_message_id)
            if contest.finish_date is None:
                await query.answer(
                    "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä—Å–∞",
                    show_alert=True
                )
                return False
        case PostMessageType.PARTNERSHIP_POST:
            pass
        case _:
            raise UnknownPostMessageTypeError

    if len(media_files) > 1 and post_message.has_button:
        await query.answer(
            "Telegram –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –º–∏–Ω–∏–º—É–º 2 –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞",
            show_alert=True
        )
        return False
    elif not media_files and not post_message.description:
        await query.answer(
            text="–í –í–∞—à–µ–º —Ä–∞—Å—Å—ã–ª–æ—á–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–µ—Ç –Ω–∏ —Ç–µ–∫—Å—Ç–∞, –Ω–∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤",
            show_alert=True
        )
        return False

    return True


async def get_post_message(
        event: Message | CallbackQuery,
        user_id: int,
        bot_id: int,
        post_message_id: int,
        post_message_type: PostMessageType | int
) -> PostMessageSchema:
    """
    Returns post message or answers that it doesn't exists anymore

    :raises PostMessageNotFoundError:
    :raises UnknownPostMessageTypeError:
    """

    try:
        post_message = await post_message_db.get_post_message(post_message_id)
        return post_message
    except PostMessageNotFoundError as e:
        if isinstance(event, Message):
            is_message = True
        else:
            is_message = False

        logger.info(
            f"user_id={user_id}: tried to edit post_message_id={post_message_id} but it doesn't exist",
            extra=extra_params(user_id=user_id, bot_idf=bot_id, post_message_id=post_message_id)
        )

        match post_message_type:
            case PostMessageType.MAILING | PostMessageType.MAILING.value:
                text = "üö´ –†–∞—Å—Å—ã–ª–∫–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∞"
            case PostMessageType.CHANNEL_POST | PostMessageType.CHANNEL_POST.value:
                text = "üö´ –ó–∞–ø–∏—Å—å –≤ –∫–∞–Ω–∞–ª —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∞"
            case PostMessageType.CONTEST | PostMessageType.CONTEST.value:
                text = "üö´ –ö–æ–Ω–∫—É—Ä—Å –≤ –∫–∞–Ω–∞–ª —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–ª–∏ —É–¥–∞–ª—ë–Ω"
            case PostMessageType.PARTNERSHIP_POST | PostMessageType.PARTNERSHIP_POST.value:
                text = "üö´ –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–ª–∏ —É–¥–∞–ª—ë–Ω"
            case _:
                raise UnknownPostMessageTypeError

        if is_message:
            await event.answer(text, reply_markup=ReplyBotMenuKeyboard.get_keyboard(bot_id))
        else:
            await event.answer(text, show_alert=True)
            await event.message.delete()

        raise e


def get_channel_id_from_query(callback_data, post_message_type: PostMessageType) -> int | None:
    """–ü—ã—Ç–∞–µ—Ç—Å—è –¥–æ—Å—Ç–∞—Ç—å channel_id –∏–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ PostMessage, –∫–æ—Ç–æ—Ä—ã–µ —Ö—Ä–∞–Ω—è—Ç –≤ —Å–µ–±–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–∞–ª–µ"""

    if post_message_type in (PostMessageType.CHANNEL_POST, PostMessageType.CONTEST):
        return callback_data.channel_id
    else:
        return None


def get_channel_id_from_state_data(state_data, post_message_type: PostMessageType) -> int | None:
    """–ü—ã—Ç–∞–µ—Ç—Å—è –¥–æ—Å—Ç–∞—Ç—å channel_id –∏–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ PostMessage, –∫–æ—Ç–æ—Ä—ã–µ —Ö—Ä–∞–Ω—è—Ç –≤ —Å–µ–±–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–∞–ª–µ"""

    if post_message_type in (PostMessageType.CHANNEL_POST, PostMessageType.CONTEST):
        return state_data["channel_id"]
    else:
        return None
